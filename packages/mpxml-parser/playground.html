<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>@mpkit/mpxml-parser</title>
        <link
            crossorigin="anonymous"
            integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
            href="https://lib.baomitu.com/font-awesome/5.15.1/css/all.min.css"
            rel="stylesheet"
        />
        <style>
            body {
                padding: 0;
                margin: 0;
            }
            h3 {
                margin-top: 0;
                border-left: 10px solid #ea7004;
                padding-left: 15px;
                box-sizing: border-box;
            }
            h3.br-right {
                border-right: 10px solid #ea7004;
                padding-right: 15px;
                border-left: none;
                padding-left: 0;
                text-align: right;
            }
            h3.br-none {
                border-left: none;
                padding-left: 0;
                text-align: center;
            }
            h3 small {
                color: #999;
                font-size: 60%;
            }
            .container {
                margin: 20px 0;
            }
            .text-group {
                display: flex;
                margin-bottom: 20px;
            }
            .text-group > .text-container:first-child > .text-editor {
                border-left: none;
            }
            .text-group > .text-container:last-child > .text-editor {
                border-right: none;
            }
            .text-container {
                flex: 1;
                flex-shrink: 1;
            }
            .text-editor {
                border: 1px solid #ededed;
                min-height: 400px;
                padding: 5px 0;
            }
            .btn-action {
                height: 40px;
                line-height: 40px;
                width: 80px;
                background: none;
                border: none;
                border-radius: 20px;
                background-image: linear-gradient(180deg, #807af3, #665ff3);
                color: #fff;
                font-size: 14px;
                position: relative;
            }
            .btn-action:focus,
            .btn-action:active {
                outline: none;
            }
            .btn-tip {
                position: absolute;
                left: 100%;
                bottom: 0;
                margin-left: 10px;
                white-space: nowrap;
                color: #666;
                font-size: 12px;
                line-height: 1.2;
                font-weight: normal;
            }
            .btn-action2 .btn-tip,
            .btn-mk .btn-tip {
                margin-right: 10px;
                margin-left: 0;
                left: auto;
                right: 100%;
            }
            .btn-tip strong {
                margin-left: 5px;
            }
            .btn-action2 {
                background-image: linear-gradient(180deg, #e4832e, #ea7004);
            }
            .btn-action3 {
                background-image: linear-gradient(180deg, #d353e4, #cd1fe4);
            }
            .chk-location {
                display: block;
                margin-bottom: 15px;
            }
            .container-options h3 {
                width: 100%;
            }
            .container-options {
                position: relative;
                flex-wrap: wrap;
                padding-bottom: 20px;
                border-bottom: 1px solid #ededed;
            }
            .container-options:after {
                content: "";
                position: absolute;
                left: 50%;
                bottom: -1px;
                height: 1px;
                background-color: #fff;
                width: 30px;
            }
            .container-options > .option-item:nth-child(2n) {
                padding-left: 30px;
            }
            .option-item {
                width: 50%;
                flex-shrink: 0;
                box-sizing: border-box;
            }
            .option-item small {
                color: #666;
            }
            .option-item > label {
                display: block;
                margin-left: 20px;
            }
            #cursor {
                display: none;
            }
            .legend {
                display: block;
                width: 100%;
            }
            .con-legend {
                margin-top: 100px;
                display: block;
                border-top: 1px solid #ededed;
                padding-top: 20px;
            }
            #longAlert,
            #failAlert {
                display: none;
                text-align: center;
                padding: 15px;
                font-size: 14px;
                border-bottom: 1px solid transparent;
            }
            a {
                margin: 0 5px;
                font-weight: bold;
            }
            #longAlert {
                color: #8a6d3b;
                background-color: #fcf8e3;
                border-bottom-color: #faebcc;
            }
            #failAlert {
                color: #a94442;
                background-color: #f2dede;
                border-bottom-color: #ebccd1;
            }
            @keyframes flash {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }
            .mpx-body-error {
                background-color: #a94442 !important;
                animation: flash 1s infinite;
            }
            .mpx-box-error {
                width: 5px !important;
                background-color: #a94442 !important;
                animation: flash 1s infinite;
            }
            .mpx-body-selection {
                background-color: #f3e6a2 !important;
            }
            .mpx-box-selection {
                width: 5px !important;
                background-color: #f3e6a2 !important;
            }
            .select-platform {
                display: block;
                width: 100%;
                height: 40px;
                line-height: 40px;
                border: 1px solid #ededed;
                border-radius: 0;
                margin-bottom: 15px;
                padding: 0 20px;
                font-size: 15px;
                font-weight: bold;
            }
            .action-container {
                width: 220px;
                padding: 0 15px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .action-container .btn-action {
                margin-bottom: 15px;
            }
            .action-container .btn-end {
                align-self: flex-end;
            }
            .action-list {
                display: flex;
                justify-content: space-between;
            }
        </style>
        <script>
            var IN_CN = new Date().toLocaleString();
            IN_CN = !!(
                IN_CN.indexOf("上午") !== -1 || IN_CN.indexOf("下午") !== -1
            );
            var longTimer = setTimeout(function () {
                document.getElementById("longAlert").style.display = "block";
            }, 5 * 1000);
            function resLoadFail(el) {
                document.getElementById("longAlert").style.display = "none";
                document.getElementById("failAlert").style.display = "block";
            }
            document.write(
                '<link rel="stylesheet" data-name="vs/editor/editor.main" href="' +
                    (IN_CN
                        ? "https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.21.2"
                        : "./monaco-editor") +
                    '/min/vs/editor/editor.main.css" onerror="resLoadFail(this)" />'
            );
        </script>
        <!-- <link
            rel="stylesheet"
            data-name="vs/editor/editor.main"
            href="./monaco-editor/min/vs/editor/editor.main.css"
            onerror="resLoadFail(this)"
        /> -->
    </head>
    <body>
        <div id="longAlert">
            在您的网络情况下，加载本站JS/CSS资源（Editor组件资源过大）速度缓慢，您可<a
                href="javascript:void"
                onclick="document.getElementById('longAlert').style.display = 'none'"
                >继续等待</a
            >或<a
                href="https://github.com/imingyu/forgiving-xml-parser/tree/gh-pages"
                target="_blank"
                >前往Github下载代码在本地运行该页面</a
            >
        </div>
        <div id="failAlert">
            JS/CSS资源加载失败！您可<a href="javascript:location.reload()"
                >重新加载页面</a
            >或<a
                href="https://github.com/imingyu/forgiving-xml-parser/tree/gh-pages"
                target="_blank"
                >前往Github下载代码在本地运行该页面</a
            >
        </div>
        <h1 style="text-align: center">@mpkit/mpxml-parser</h1>
        <!-- <div class="container container-options">
            <h3>可选配置</h3>
            <label class="option-item">
                <input type="checkbox" />
                <b>allowStartTagLeftBoundarySpace</b>
                <small>是否允许开始标签的左边界符附近存在空白字符</small>
            </label>
            <label class="option-item">
                <input type="checkbox" />
                <b>ignoreTagNameCaseEqual</b>
                <small>忽略标签名称大小写对比</small>
            </label>
            <label class="option-item">
                <input type="checkbox" />
                <b>allowNodeNotClose</b>
                <small>是否允许标签不关闭</small>
            </label>
            <label class="option-item">
                <input type="checkbox" />
                <b>allowNodeNameEmpty</b>
                <small>是否允许节点名称为空</small>
            </label>
            <label class="option-item">
                <input type="checkbox" />
                <b>allowAttrContentHasBr</b>
                <small
                    >是否允许属性值中存在换行，仅在属性表达式中包含边界符（“"”,“'”）时生效</small
                >
            </label>
            <label class="option-item">
                <input type="checkbox" />
                <b>allowNearAttrEqualSpace</b>
                <small>是否允许属性等号附近存在空白字符</small>
            </label>
            <div class="option-item">
                <b>encounterAttrMoreEqual</b>
                <small>当遇到属性中含有多个“=”时怎么处置？</small>
                <label>
                    <input
                        type="radio"
                        name="encounterAttrMoreEqual"
                        value="throwError"
                    />
                    <b>throwError</b>
                    <small>报错</small>
                </label>
                <label>
                    <input
                        type="radio"
                        name="encounterAttrMoreEqual"
                        value="merge"
                    />
                    <b>merge</b>
                    <small>合并</small>
                </label>
                <label>
                    <input
                        type="radio"
                        name="encounterAttrMoreEqual"
                        value="newAttr"
                    />
                    <b>newAttr</b>
                    <small>新创建一个属性对象</small>
                </label>
            </div>
        </div> -->
        <div class="container">
            <div class="text-group">
                <div class="text-container">
                    <h3>MpXML</h3>
                    <div class="editor-box">
                        <div class="text-editor xml-editor"></div>
                    </div>
                </div>
                <div class="action-container ac-1">
                    <button class="btn-action btn-parse" type="button">
                        <i class="fa fa-angle-double-right"></i>
                    </button>
                    <div class="chk-list">
                        <label class="chk-location">
                            <input type="checkbox" name="location" />
                            显示节点位置信息
                        </label>
                        <label class="chk-location">
                            <input type="checkbox" name="steps" />
                            显示节点解析步骤信息
                        </label>
                    </div>
                    <select class="select-platform" name="platform">
                        <option value="wechat" label="微信" selected></option>
                        <option value="alipay" label="支付宝"></option>
                        <option value="smart" label="百度"></option>
                        <option value="tiktok" label="字节跳动"></option>
                    </select>
                    <button
                        class="btn-action btn-action2 btn-end btn-serialize"
                        type="button"
                    >
                        <i class="fa fa-angle-double-left"></i>
                    </button>
                </div>
                <div class="text-container">
                    <h3 class="br-right">JSON</h3>
                    <div class="editor-box">
                        <div class="text-editor json-editor"></div>
                    </div>
                </div>
            </div>
            <div class="text-group" style="display: block">
                <div class="action-list">
                    <div class="action-container ac-2">
                        <button
                            class="btn-action btn-action3 btn-mp"
                            type="button"
                        >
                            <i class="fa fa-angle-double-up"></i>
                        </button>
                        <select class="select-platform" name="platform">
                            <option
                                value="wechat"
                                label="微信"
                                selected
                            ></option>
                            <option value="alipay" label="支付宝"></option>
                            <option value="smart" label="百度"></option>
                            <option value="tiktok" label="字节跳动"></option>
                        </select>
                        <button
                            class="btn-action btn-action3 btn-end btn-mk"
                            type="button"
                        >
                            <i class="fa fa-angle-double-down"></i>
                        </button>
                    </div>
                    <div class="action-container ac-3">
                        <button class="btn-action btn-parse" type="button">
                            <i class="fa fa-angle-double-up"></i>
                        </button>
                        <select class="select-platform" name="platform">
                            <option
                                value="wechat"
                                label="微信"
                                selected
                            ></option>
                            <option value="alipay" label="支付宝"></option>
                            <option value="smart" label="百度"></option>
                            <option value="tiktok" label="字节跳动"></option>
                        </select>
                        <button
                            class="btn-action btn-action2 btn-end btn-serialize"
                            type="button"
                        >
                            <i class="fa fa-angle-double-down"></i>
                        </button>
                    </div>
                </div>
                <h3 class="br-none">
                    MkTransltorXML
                    <span id="cursor"
                        ><small
                            >（光标位置 行：<span id="cusLine"></span> 列：<span
                                id="cusCol"
                            ></span
                            >）</small
                        ></span
                    >
                </h3>
                <div class="editor-box">
                    <div class="text-editor xml-editor"></div>
                </div>
            </div>
        </div>
        <script
            src="./dist/index.umd.full.js"
            onerror="resLoadFail(this)"
        ></script>
        <!-- <script src="./dist/index.umd.js"></script> -->
        <!-- <script src="./jquery.min.js" onerror="resLoadFail(this)"></script> -->
        <script>
            document.write(
                '<script src="' +
                    (IN_CN
                        ? "https://cdn.bootcdn.net/ajax/libs/jquery/2.2.4"
                        : ".") +
                    '/jquery.min.js" onerror="resLoadFail(this)"><\/script>'
            );
            var require = {
                paths: {
                    vs:
                        (IN_CN
                            ? "https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.21.2"
                            : "./monaco-editor") + "/min/vs",
                },
            };
            document.write(
                '<script src="' +
                    (IN_CN
                        ? "https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.21.2"
                        : "./monaco-editor") +
                    '/min/vs/loader.js" onerror="resLoadFail(this)"><\/script>'
            );
            document.write(
                '<script src="' +
                    (IN_CN
                        ? "https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.21.2"
                        : "./monaco-editor") +
                    '/min/vs/editor/editor.main.nls.js" onerror="resLoadFail(this)"><\/script>'
            );
            document.write(
                '<script src="' +
                    (IN_CN
                        ? "https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.21.2"
                        : "./monaco-editor") +
                    '/min/vs/editor/editor.main.js" onerror="resLoadFail(this)"><\/script>'
            );
        </script>
        <!-- <script
            src="./monaco-editor/min/vs/loader.js"
            onerror="resLoadFail(this)"
        ></script>
        <script
            src="./monaco-editor/min/vs/editor/editor.main.nls.js"
            onerror="resLoadFail(this)"
        ></script>
        <script
            src="./monaco-editor/min/vs/editor/editor.main.js"
            onerror="resLoadFail(this)"
        ></script> -->

        <script>
            clearTimeout(longTimer);
            document.getElementById("longAlert").style.display = "none";
            var editorMap = {};
            var setXmlError = (
                editorState,
                startLine,
                startCol,
                endLine,
                endCol
            ) => {
                endLine = endLine || startLine;
                endCol = endCol || startCol + 1;
                editorState.lastXmlErrorDecorations = editorState.editor.deltaDecorations(
                    editorState.lastXmlErrorDecorations || [],
                    [
                        {
                            range: new monaco.Range(
                                startLine,
                                startCol,
                                endLine,
                                endCol
                            ),
                            options: {
                                className: "mpx-body-error",
                                linesDecorationsClassName: "mpx-box-error",
                            },
                        },
                    ]
                );
            };
            var clearXmlError = (editorState) => {
                if (editorState.lastXmlErrorDecorations) {
                    editorState.editor.deltaDecorations(
                        editorState.lastXmlErrorDecorations,
                        []
                    );
                    editorState.lastXmlErrorDecorations = null;
                }
            };

            function editorInit() {
                Array.from($(".xml-editor"))
                    .concat(Array.from($(".json-editor")))
                    .forEach((el, index) => {
                        el = $(el);
                        const state = {
                            type: el.is(".xml-editor") ? "xml" : "json",
                            el,
                            parent: el.closest(".text-group"),
                        };
                        state.h3 = state.parent.find("h3");

                        if (!index) {
                            state.id = "mpXml";
                        } else if (state.type === "xml") {
                            state.id = "mkXml";
                        } else {
                            state.id = "json";
                        }
                        if (state.type === "xml") {
                            state.content =
                                localStorage.getItem(
                                    `Mkp.${state.id}EditorContent`
                                ) || "";
                        }
                        if (state.id === "mpXml" && !state.content) {
                            state.content =
                                '<wxs module="tool" src="./tool.wxs" />\n<view wx:for="{{products}}" wx:for-item="product">\n    <image src="{{tool.cdn(product.img)}}">\n    <text>{{product.name}}</text>\n    <text wx:if="{{product.price}}">{{product.price}}</text>\n</view>';
                        }
                        state.editor = monaco.editor.create(el[0], {
                            value: state.content,
                            language: state.type,
                            minimap: {
                                enabled: false,
                            },
                        });

                        if (state.type === "xml") {
                            state.editor.onDidChangeModelContent((e) => {
                                clearXmlError(state);
                            });
                        }

                        state.editor.onDidChangeCursorPosition(function (e) {
                            const cursorHtml = `<small class="cursor">（光标位置 行：<span class="cus-line">${e.position.lineNumber}</span> 列：<span class="cus-col">${e.position.column}</span>）</small>`;
                            state.h3.children(".cursor").remove();
                            state.h3.append(cursorHtml);
                        });

                        editorMap[state.id] = state;
                    });
            }

            const setBtnTime = (btn, time) => {
                btn.children(".btn-tip").remove();
                btn.append(
                    `<span class="btn-tip">本次操作耗时：<strong>${time.toFixed(
                        2
                    )}ms</strong></span>`
                );
            };

            function btnEventInit() {
                $(".btn-parse").click(function () {
                    const btn = $(this);
                    const parent = btn.closest(".text-group");
                    const xmlEditorContainer = parent.children(
                        ".text-container:eq(0)"
                    );
                    const actionBox = btn.closest(".action-container");
                    const toPlatform = actionBox.find(".select-platform").val();
                    let state;
                    if (!xmlEditorContainer.length) {
                        state = editorMap.mkXml;
                    } else {
                        state = editorMap.mpXml;
                    }
                    localStorage.setItem(
                        `Mkp.${state.id}EditorContent`,
                        state.editor.getValue()
                    );
                    const startTime = (performance || Date).now();
                    const json = MpKitMpxmlParser.parseMpXml(
                        state.editor.getValue(),
                        toPlatform
                    );
                    setBtnTime(btn, (performance || Date).now() - startTime);
                    const needLoc = actionBox
                        .find('input[name="location"]')
                        .prop("checked");
                    const needSteps = actionBox
                        .find('input[name="steps"]')
                        .prop("checked");
                    var parseResult = MpKitMpxmlParser.toJSON(
                        json.nodes,
                        needLoc,
                        needSteps
                    );
                    if (json.error) {
                        console.error(json.error.stack);
                        const target = json.error.target;
                        delete json.error.target;
                        editorMap.json.editor.setValue(
                            JSON.stringify(
                                {
                                    ...json.error,
                                    message: json.error.message,
                                    target: target
                                        ? MpKitMpxmlParser.toJSON(
                                              target,
                                              needLoc,
                                              needSteps
                                          )
                                        : null,
                                },
                                null,
                                4
                            )
                        );
                        json.error.target = target;
                    } else {
                        editorMap.json.editor.setValue(
                            JSON.stringify(parseResult, null, 4)
                        );
                    }
                    if (json.error && json.error.lineNumber) {
                        setXmlError(
                            state,
                            json.error.lineNumber,
                            json.error.column
                        );
                    }
                });

                $(".btn-serialize").click(function () {
                    const btn = $(this);
                    const parent = btn.closest(".text-group");
                    const xmlEditorContainer = parent.children(
                        ".text-container:eq(0)"
                    );
                    let state;
                    if (!xmlEditorContainer.length) {
                        state = editorMap.mkXml;
                    } else {
                        state = editorMap.mpXml;
                    }
                    let json = editorMap.json.editor.getValue().trim();
                    if (json) {
                        try {
                            json = JSON.parse(json);
                        } catch (error) {
                            return alert("请输入有效的JSON后再尝试序列化");
                        }
                    }
                    if (!json) {
                        return alert("请输入有效的JSON后再尝试序列化");
                    }
                    const actionBox = btn.closest(".action-container");
                    const toPlatform = actionBox.find(".select-platform").val();
                    const startTime = (performance || Date).now();
                    const xml = MpKitMpxmlParser.serialize(json, toPlatform);
                    setBtnTime(btn, (performance || Date).now() - startTime);
                    state.editor.setValue(xml);
                });
            }

            editorInit();
            btnEventInit();
        </script>
    </body>
</html>
